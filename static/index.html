<script>
const startBtn = document.getElementById('startBtn');
const progressBar = document.getElementById('progressBar');
const statusText = document.getElementById('statusText');
const downloadLink = document.getElementById('downloadLink');

let jobId = null;
let pollInterval = null;

startBtn.addEventListener('click', async () => {
  // 입력값 가져오기
  const videoId = document.getElementById('videoId').value.trim();
  const referer = document.getElementById('referer').value.trim();
  const filename = document.getElementById('filename').value.trim();

  if (!videoId || !referer || !filename) {
    alert("모든 필드를 입력해주세요!");
    return;
  }

  // 초기화
  progressBar.value = 0;
  statusText.textContent = "서버에 다운로드 요청 중...";
  downloadLink.innerHTML = "";
  clearInterval(pollInterval);

  try {
    // ✅ 서버에 JSON으로 POST 요청
    const res = await fetch('/download', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        video_id: videoId,
        referer: referer,
        filename: filename
      })
    });

    if (!res.ok) {
      const errorText = await res.text();
      throw new Error(`서버 오류: ${res.status} ${errorText}`);
    }

    const data = await res.json();
    if (!data.job_id) {
      throw new Error("서버 응답에 job_id가 없습니다.");
    }

    jobId = data.job_id;
    statusText.textContent = `✅ Job ID 발급됨: ${jobId}`;

    // ✅ 폴링 시작
    pollInterval = setInterval(checkStatus, 2000);

  } catch (err) {
    statusText.textContent = "❌ 요청 실패: " + err.message;
  }
});

async function checkStatus() {
  if (!jobId) return;

  try {
    const res = await fetch(`/status/${jobId}`);
    if (!res.ok) {
      throw new Error(`서버 오류: ${res.status}`);
    }

    const data = await res.json();

    if (data.error) {
      clearInterval(pollInterval);
      statusText.textContent = "❌ 오류: " + data.error;
      return;
    }

    if (data.status === "downloading") {
      progressBar.value = data.progress;
      statusText.textContent = `⬇️ 다운로드 중... ${data.progress}%`;
    }

    if (data.status === "completed") {
      clearInterval(pollInterval);
      progressBar.value = 100;
      statusText.textContent = "✅ 다운로드 완료!";
      downloadLink.innerHTML = `<a href="${data.download_url}" target="_blank" download>파일 다운로드</a>`;
    }

    if (data.status === "error") {
      clearInterval(pollInterval);
      statusText.textContent = "❌ 서버 처리 오류: " + data.error;
    }

  } catch (err) {
    clearInterval(pollInterval);
    statusText.textContent = "❌ 상태 확인 실패: " + err.message;
  }
}
</script>
